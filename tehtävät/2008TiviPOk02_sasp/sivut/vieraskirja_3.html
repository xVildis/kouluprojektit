  <!DOCTYPE html>
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Vieraskirja (1)</title>
	<LINK REL=stylesheet type="text/css" href="style.css">
</head>

<script type="text/javascript" src="header2.js"> </script>
<div id="sisalto">

<h1>3. Tietokannan toteutus</h1>
<ol>
<li><a href="vieraskirja_1.html">tehtävä</a></li>
<li><a href="vieraskirja_2.html">suunnitelma</a></li>
<li><a href="vieraskirja_3.html">tietokannan toteutus</a></li>
<li><a href="vieraskirja_4.html">käyttöliittymä</a></li>
<li><a href="vieraskirja_5.html">runko järjestelmään</a></li>
<li><a href="vieraskirja_6.html">tietojen lisäys lukijan näkymässä</a></li>
<li><a href="vieraskirja_7.html">autentikointi</a></li>
<li><a href="vieraskirja_8.html">jutun lisäys ylläpitonäkymässä</a></li>
<li><a href="vieraskirja_9.html">tietojen haku lukijan näkymässä</a></li>
<li><a href="vieraskirja_10.html">tietojen haku ylläpitonäkymässä</a></li>
</ol>
<h2>Tämän tunnin tavoite</h2>
<p>Toteuta yhteys.php. Laadi asennusohjelma, joka käyttää hyväkseen funktioita.</p>

<h3>Tallennuspaikat</h3>
<p>Luo neljä alikansiota - tietokanta, kirjastot, tyyli ja sisalto.</p>
<p>Tallenna perustiedostot (asenna.php, admin.php, index.php, tarkista_kirjautuminen.php ja kirjaudu_ulos.php) juurikansioon.</p>
<p>Käytä kirjastot-kansiota funktiokirjastoille (funktiot.php) sekä html-aluille ja lopuille (alku.php, loppu.php, admin_alku.php ja admin_loppu.php).</p>
<p>Käytä tietokanta-kansiota tietokantafunktiokirjastoille (tkfunktiot.php) ja yhteys.php:lle
<p>Laita sivu.css tyylikansiooon ja luo sen sisälle kuvat-kansio, johon sijoitat käyttöliittymän rakenteeseen liittyvät kuvat.</p>
<p>Sisältö-sivut sijoitetaan sisalto-kansioon (kirjaudu.php, rekisteroidy.php, etusivu.php, kirjoittajan_jutut.php, juttu.php sekä admin_etusivu.php, lisaa_juttu.php, muokkaa_juttua.php ja muokkaa_omia_tietoja.php).</p>

<h3>./tietokanta/yhteys.php</h3>
<p class="koodi">
<code><span style="color: #000000">
<span style="color: #0000BB">&lt;?php
<br />$host&nbsp;</span><span style="color: #007700">=</span><span style="color: #DD0000">"samarium"</span><span style="color: #007700">;
<br /></span><span style="color: #0000BB">$user&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #DD0000">"tunnus"</span><span style="color: #007700">;
<br /></span><span style="color: #0000BB">$pass&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #DD0000">"salasana"</span><span style="color: #007700">;
<br /></span><span style="color: #0000BB">$dbname&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #DD0000">"tietokanta"</span><span style="color: #007700">;
<br />
<br />try&nbsp;</span><span style="color: #FF8000">//yritetään&nbsp;ottaa&nbsp;yhteys
<br /></span><span style="color: #007700">{&nbsp;
<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">$yhteys&nbsp;</span><span style="color: #007700">=&nbsp;new&nbsp;</span><span style="color: #0000BB">PDO</span><span style="color: #007700">(</span><span style="color: #DD0000">"mysql:host=</span><span style="color: #0000BB">$host</span><span style="color: #DD0000">;dbname=</span><span style="color: #0000BB">$dbname</span><span style="color: #DD0000">;charset=utf8"</span><span style="color: #007700">,
<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">$user</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">$pass</span><span style="color: #007700">);&nbsp;
<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF8000">//luo&nbsp;PDO-olion
<br /></span><span style="color: #007700">}&nbsp;
<br />catch(</span><span style="color: #0000BB">PDOException&nbsp;$e</span><span style="color: #007700">)&nbsp;</span><span style="color: #FF8000">//&nbsp;jos&nbsp;ei&nbsp;onnistu&nbsp;(poikkeus)
<br /></span><span style="color: #007700">{&nbsp;
<br />&nbsp;&nbsp;&nbsp;&nbsp;echo&nbsp;</span><span style="color: #0000BB">$e</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">getMessage</span><span style="color: #007700">();&nbsp;</span><span style="color: #FF8000">//antaa&nbsp;ilmoituksen&nbsp;siitä,&nbsp;missä&nbsp;virhe
<br /></span><span style="color: #007700">}
<br /></span><span style="color: #0000BB">?&gt;</span>
</span>
</code></p>

<h2>Laadi asennusohjelma ./tietokanta/asenna.php</h2>
<p>Asennusohjelma luo tietokantaan tarvittavat taulut, tallenna kansioon tietokanta. <br />Jos haluat kehittää asennusohjelmaa pidemmälle, laadi siitä sellainen, että se tulostaa lomakkeen, jossa pyytää tarvittavat tiedot - tietokantaympäristö, skeema, käyttäjätunnus ja salasana ja tallentaa tiedot erilliseen tiedostoon, joka haetaan käyttöön tietokantafunktioiden avulla.<tr><br /> Huom. ko. tiedosto ei saa olla public_html:n alla ja sen tarkennin saisi olla .php, sillä muutoin se on helppo tulostaa näkyville html-sivuna.</p>

<h3>./tietokanta/asenna.php</h3>
<p>Molempiin tauluhin kerrotaan tallennettavan tiedon merkistö ja annetaan järjestelmämääritys innoDb.</p>
<p>Taulun juttu vierasavaimeksi määritetään kayttaja-taulun pääavain.</p>

<p class="koodi">
<code><span style="color: #000000">
&lt;!doctype&nbsp;html&gt;<br />&lt;html&gt;<br />&lt;head&gt;<br />&lt;title&gt;Asennus&lt;/title&gt;<br />&lt;meta&nbsp;charset="utf-8"&gt;<br />&lt;/head&gt;<br />&lt;body&gt;<br /><span style="color: #0000BB">&lt;?php<br /></span><span style="color: #007700">require&nbsp;</span><span style="color: #DD0000">"./yhteys.php"</span><span style="color: #007700">;<br /><br /></span><span style="color: #0000BB">$sql</span><span style="color: #007700">=</span><span style="color: #DD0000">"DROP&nbsp;TABLE&nbsp;IF&nbsp;EXISTS&nbsp;juttu"</span><span style="color: #007700">;<br /></span><span style="color: #0000BB">$kysely&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">$yhteys</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">query</span><span style="color: #007700">(</span><span style="color: #0000BB">$sql</span><span style="color: #007700">);<br />if(</span><span style="color: #0000BB">$kysely</span><span style="color: #007700">!=</span><span style="color: #0000BB">FALSE</span><span style="color: #007700">)&nbsp;echo&nbsp;</span><span style="color: #DD0000">"Poistetaan&nbsp;vanhat&nbsp;juttu-taulut..&lt;br&gt;"</span><span style="color: #007700">;<br /><br /></span><span style="color: #0000BB">$sql</span><span style="color: #007700">=</span><span style="color: #DD0000">"DROP&nbsp;TABLE&nbsp;IF&nbsp;EXISTS&nbsp;kayttaja"</span><span style="color: #007700">;<br /></span><span style="color: #0000BB">$kysely&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">$yhteys</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">query</span><span style="color: #007700">(</span><span style="color: #0000BB">$sql</span><span style="color: #007700">);<br />if(</span><span style="color: #0000BB">$kysely</span><span style="color: #007700">)&nbsp;echo&nbsp;</span><span style="color: #DD0000">"Poistetaan&nbsp;vanhat&nbsp;kayttaja-taulut..&lt;br&gt;"</span><span style="color: #007700">;<br /><br /></span><span style="color: #0000BB">$sql</span><span style="color: #007700">=</span><span style="color: #DD0000">"CREATE&nbsp;TABLE&nbsp;IF&nbsp;NOT&nbsp;EXISTS&nbsp;kayttaja(kid&nbsp;INT(6)&nbsp;NOT&nbsp;NULL&nbsp;AUTO_INCREMENT&nbsp;PRIMARY&nbsp;KEY,<br />sukunimi&nbsp;VARCHAR(30),<br />etunimi&nbsp;VARCHAR(30),<br />ktunnus&nbsp;VARCHAR(30),<br />salasana&nbsp;VARCHAR(100))&nbsp;ENGINE&nbsp;InnoDB&nbsp;CHARACTER&nbsp;SET&nbsp;utf8&nbsp;COLLATE&nbsp;utf8_general_ci"</span><span style="color: #007700">;<br /></span><span style="color: #0000BB">$kysely&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">$yhteys</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">query</span><span style="color: #007700">(</span><span style="color: #0000BB">$sql</span><span style="color: #007700">);<br />if(</span><span style="color: #0000BB">$kysely</span><span style="color: #007700">!=</span><span style="color: #0000BB">FALSE</span><span style="color: #007700">)&nbsp;echo&nbsp;</span><span style="color: #DD0000">"Taulu&nbsp;kayttaja&nbsp;lisätty!&lt;br&gt;"</span><span style="color: #007700">;<br /><br /></span><span style="color: #0000BB">$sql</span><span style="color: #007700">=</span><span style="color: #DD0000">"CREATE&nbsp;TABLE&nbsp;IF&nbsp;NOT&nbsp;EXISTS&nbsp;juttu(jid&nbsp;INT(6)&nbsp;NOT&nbsp;NULL&nbsp;AUTO_INCREMENT&nbsp;PRIMARY&nbsp;KEY,<br />otsikko&nbsp;VARCHAR(100),<br />kpl&nbsp;TEXT,<br />poistamispvm&nbsp;DATE&nbsp;NOT&nbsp;NULL,<br />lisayspvm&nbsp;DATE,&nbsp;kid&nbsp;INT(6))&nbsp;ENGINE&nbsp;InnoDB&nbsp;CHARACTER&nbsp;SET&nbsp;utf8&nbsp;COLLATE&nbsp;utf8_general_ci"</span><span style="color: #007700">;&nbsp;<br /></span><span style="color: #0000BB">$kysely&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">$yhteys</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">query</span><span style="color: #007700">(</span><span style="color: #0000BB">$sql</span><span style="color: #007700">);<br />if(</span><span style="color: #0000BB">$kysely</span><span style="color: #007700">!=</span><span style="color: #0000BB">FALSE</span><span style="color: #007700">)&nbsp;echo&nbsp;</span><span style="color: #DD0000">"Taulu&nbsp;juttu&nbsp;lisätty!&lt;br&gt;"</span><span style="color: #007700">;<br /><br /></span><span style="color: #0000BB">$sql</span><span style="color: #007700">=</span><span style="color: #DD0000">"ALTER&nbsp;TABLE&nbsp;juttu&nbsp;ADD&nbsp;CONSTRAINT&nbsp;vieras&nbsp;FOREIGN&nbsp;KEY&nbsp;(kid)&nbsp;REFERENCES&nbsp;kayttaja(kid)"</span><span style="color: #007700">;<br /></span><span style="color: #0000BB">$kysely&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">$yhteys</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">query</span><span style="color: #007700">(</span><span style="color: #0000BB">$sql</span><span style="color: #007700">);<br />if(</span><span style="color: #0000BB">$kysely</span><span style="color: #007700">!=</span><span style="color: #0000BB">FALSE</span><span style="color: #007700">)&nbsp;echo&nbsp;</span><span style="color: #DD0000">"Vierasavain&nbsp;on&nbsp;lisätty!&lt;br&gt;"</span><span style="color: #007700">;<br /></span><span style="color: #0000BB">?&gt;<br /></span>&lt;/body&gt;<br />&lt;/html&gt;</span>
</code></p>


</div>

<script type="text/javascript" src="footer.js"> </script>